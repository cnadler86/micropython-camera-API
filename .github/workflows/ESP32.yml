name: Build MicroPython for ESP32 Boards

on:
  push:
    branches:
      - CI

jobs:
  setup-environment:
    runs-on: ubuntu-latest
    outputs:
      idf-path: ${{ steps.export-idf.outputs.idf-path }}
      micropython-path: ${{ steps.clone-micropython.outputs.micropython-path }}
    steps:
      # 1. Check out the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Install ESP-IDF dependencies
      - name: Install ESP-IDF dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget flex bison gperf python3 python3-pip python3-setuptools cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0

      # 3. Download and set up ESP-IDF 5.2.x
      - name: Set up ESP-IDF 5.2.x
        id: export-idf
        run: |
          git clone --branch release/v5.2 --recursive https://github.com/espressif/esp-idf.git
          cd esp-idf
          ./install.sh
          echo "::set-output name=idf-path::$(pwd)"

      # 4. Clone the latest MicroPython release
      - name: Clone MicroPython latest release
        id: clone-micropython
        run: |
          # Fetch the latest MicroPython release tag using GitHub API
          LATEST_RELEASE=$(curl --silent "https://api.github.com/repos/micropython/micropython/releases/latest" | jq -r .tag_name)
          echo "Cloning MicroPython release: $LATEST_RELEASE"
          git clone --depth 1 --branch $LATEST_RELEASE https://github.com/micropython/micropython.git
          cd micropython
          git submodule update --init --depth 1
          echo "::set-output name=micropython-path::$(pwd)"
